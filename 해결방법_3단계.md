# 🎯 Google Apps Script 전송 오류 - 3단계 해결 가이드

## ⚡ 가장 빠른 해결 순서

### ✅ 1단계: Apps Script 설정 확인 (1분)

1. **Apps Script 편집기 열기**
   - 구글 시트 → 확장 프로그램 > Apps Script

2. **설정 확인 함수 실행**
   - 함수 선택: `checkConfig`
   - **실행** 버튼 클릭 (▶️)
   - **실행 > 로그** 클릭 (Ctrl+Enter)

3. **로그 확인**
   ```
   ✅ SECRET_TOKEN: 121217 (또는 설정됨)
   ✅ SPREADSHEET_ID: 17fKb6pNg1rHrLm-Jd4QxKiDsnQUPwI40dy9UBcegOf4
   ✅ 시트 접근 가능
   ```

   ❌ **오류가 보이면:**
   - `setupScriptProperties()` 함수 다시 실행
   - 로그에서 "설정 완료!" 메시지 확인

---

### ✅ 2단계: 웹 앱 재배포 (중요! 2분)

**⚠️ 이것이 가장 중요한 단계입니다!**

설정을 변경한 후에는 **반드시 웹 앱을 재배포**해야 합니다.

#### 재배포 방법:

1. **배포 관리 열기**
   - Apps Script 편집기 → **배포 > 배포 관리**

2. **기존 배포 수정**
   - 기존 배포 옆 **연필 아이콘(✏️)** 클릭

3. **새 버전으로 배포**
   - **버전**: **새 버전** 선택
   - **설명** (선택사항): "설정 업데이트"
   - **배포** 버튼 클릭

4. **Web App URL 복사**
   - 배포 후 표시되는 URL 복사
   - 예: `https://script.google.com/macros/s/AKfycby.../exec`

5. **Vercel 환경 변수 업데이트**
   - Vercel 대시보드 → 프로젝트 → **Settings** → **Environment Variables**
   - `GOOGLE_APPS_SCRIPT_URL` 값에 새 URL 붙여넣기
   - 저장

---

### ✅ 3단계: Vercel 환경 변수 확인 (1분)

1. **Vercel 대시보드 접속**
   - 프로젝트 선택 → **Settings** → **Environment Variables**

2. **다음 변수 확인:**

   | 변수 이름 | 값 | 확인 사항 |
   |---------|-----|---------|
   | `GOOGLE_APPS_SCRIPT_URL` | `https://script.google.com/macros/s/.../exec` | 2단계에서 복사한 URL과 동일한지 확인 |
   | `GOOGLE_APPS_SCRIPT_TOKEN` | `121217` | Apps Script의 SECRET_TOKEN과 동일한지 확인 |

3. **변경 사항 저장**
   - 값이 다르면 수정
   - 저장 후 Vercel 함수 자동 재배포 (몇 분 소요)

---

## 🧪 4단계: 테스트

### 테스트 1: Web App URL 직접 접속

브라우저에서 Web App URL에 직접 접속:

```
https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec
```

**정상 응답:**
```json
{
  "message": "Google Apps Script Web App 정상 작동 중",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

**오류 응답:**
- HTML 로그인 페이지가 보이면 → **배포 설정 확인**
- 오류 메시지가 보이면 → **Apps Script 로그 확인**

### 테스트 2: 사이트에서 폼 제출

1. 웹사이트에서 폼 제출
2. Apps Script 편집기 → **실행 > 로그** 확인
3. 다음 로그가 보이면 성공:
   ```
   🚀 === doPost 호출됨 ===
   ✅ POST 요청 확인됨
   ✅ JSON 파싱 성공
   ✅ 토큰 검증 완료
   ✅ 시트 접근 성공
   ✅ 행 추가 성공
   🎉 === 모든 과정 성공 완료 ===
   ```

---

## 🔍 배포 설정 확인 (문제가 계속되면)

웹 앱 배포 시 다음 설정이 **반드시** 올바르게 되어 있어야 합니다:

### ✅ 올바른 설정:

1. **다음 사용자 인증 정보로 실행**: **나**
2. **엑세스 권한이 있는 사용자**: **모든 사용자**

### ❌ 잘못된 설정:

- "나"로 실행 + "나" 접근 권한 → 외부에서 접근 불가!
- "사용자에게 인증 요청" → 로그인 페이지 표시!

### 설정 변경 방법:

1. **배포 > 배포 관리**에서 기존 배포 삭제
2. **배포 > 새 배포** 클릭
3. 올바른 설정으로 새로 배포

---

## 📋 체크리스트

다음 사항을 모두 확인했는지 체크하세요:

- [ ] `checkConfig()` 함수 실행 → 로그에서 설정 확인됨
- [ ] **웹 앱 재배포 완료** (새 버전)
- [ ] Vercel `GOOGLE_APPS_SCRIPT_URL` 업데이트
- [ ] Vercel `GOOGLE_APPS_SCRIPT_TOKEN`이 `121217`인지 확인
- [ ] 배포 설정: "나"로 실행 + "모든 사용자" 접근
- [ ] Web App URL 브라우저에서 직접 접속 테스트 성공
- [ ] 사이트에서 폼 제출 테스트 성공

---

## 🆘 여전히 오류가 발생하는 경우

### 1. Apps Script 로그 확인

1. Apps Script 편집기 → **실행 > 로그**
2. 폼 제출 시도
3. 오류 메시지 전체 복사

### 2. Vercel 로그 확인

1. Vercel 대시보드 → 프로젝트 → **Functions** 탭
2. `api/submit.js` 로그 확인
3. 오류 메시지 전체 복사

### 3. 다음 정보를 수집하여 문제 진단:

- Apps Script 로그 전체
- Vercel 로그 전체
- 환경 변수 설정 스크린샷
- 오류 메시지 전체

---

## 💡 핵심 요약

**가장 중요한 것은 웹 앱 재배포입니다!**

1. ✅ 설정 변경 (`setupScriptProperties()` 실행)
2. ✅ **웹 앱 재배포** (반드시!)
3. ✅ Vercel 환경 변수 업데이트
4. ✅ 테스트

**3단계를 따라하면 5분 안에 해결됩니다!** 🎉

